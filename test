import asyncio
import json
from typing import Sequence, Any, MutableMapping

from agent_framework import (
    ChatAgent,
    BaseChatClient,
    MCPStreamableHTTPTool,
    ChatMessage,
    ChatResponse,
    Role,
    TextContent,
    ToolProtocol,
    ChatOptions,
)

from langchain_core.prompts import ChatPromptTemplate
from safechain.lcel import model


# =====================================================
# Helpers
# =====================================================
def extract_text_from_message(m: ChatMessage) -> str:
    if m.contents:
        return getattr(m.contents[0], "text", "")
    return ""


def extract_mcp_text(result):
    if result is None:
        return []
    if isinstance(result, list):
        return result
    if isinstance(result, dict):
        return [result]
    return []


def merge_chat_options(
    *,
    base_chat_options: ChatOptions | None = None,
    tools=None,
    tool_choice="none",
):
    if base_chat_options is None:
        base_chat_options = ChatOptions()
    return base_chat_options & ChatOptions(
        tools=tools,
        tool_choice=tool_choice,
    )


# =====================================================
# Flight Prompt (ChatPromptTemplate SAFE)
# =====================================================
def flight_prompt(planner_json: dict, flights: list[dict]) -> str:
    return f"""
You are a Flight Booking Agent.

Your responsibility:
- Rank flights by lowest price and highest rating
- Respect user budget and preferences
- Select ONE best flight

Planner Input (structured):
{json.dumps(planner_json, indent=2)}

Available Flights:
{json.dumps(flights, indent=2)}

Rules:
- Choose the best flight
- Explain briefly WHY
- Do NOT invent flights

Return a short explanation.
"""


# =====================================================
# Flight Chat Client
# =====================================================
class FlightChatClient(BaseChatClient):

    async def _inner_get_response(
        self,
        messages: Sequence[ChatMessage],
        *,
        tools: Sequence[ToolProtocol] | None = None,
        chat_options: MutableMapping[str, Any] | None = None,
        **kwargs: Any,
    ) -> ChatResponse:

        # 1️⃣ Read planner JSON from user message
        planner_json = json.loads(extract_text_from_message(messages[-1]))

        origin = planner_json.get("origin_city")
        destination = planner_json.get("destination_city")
        budget = planner_json.get("budget", 999999)

        flights = []

        chat_option = merge_chat_options(
            base_chat_options=chat_options,
            tools=tools,
        )

        # 2️⃣ Call MCP tools
        if chat_option.tools:
            for tool in chat_option.tools:

                if tool.name == "search_flights":
                    raw = await tool.invoke(
                        origin=origin,
                        destination=destination,
                        max_price_usd=budget,
                    )
                    flights = extract_mcp_text(raw)

                if tool.name == "get_flight_booking_details":
                    await tool.invoke(
                        start=origin,
                        destination=destination,
                    )

        # 3️⃣ Build prompt (ChatPromptTemplate REQUIRED)
        prompt = ChatPromptTemplate.from_messages(
            [
                ("system", "You are a flight booking expert."),
                ("human", "{content}")
            ]
        ).format(
            content=flight_prompt(planner_json, flights)
        )

        # 4️⃣ Call model
        llm = model("3")
        result = llm.invoke(prompt)

        return ChatResponse(
            messages=ChatMessage(
                role=Role.ASSISTANT,
                contents=[TextContent(text=result.content)],
            )
        )

    async def _inner_get_streaming_response(self, *args, **kwargs):
        raise NotImplementedError("Streaming not supported")


# =====================================================
# MCP Tools
# =====================================================
flight_search_mcp = MCPStreamableHTTPTool(
    name="search_flights",
    url="http://localhost:8006/mcp",
)

flight_booking_mcp = MCPStreamableHTTPTool(
    name="get_flight_booking_details",
    url="http://localhost:8006/mcp",
)


# =====================================================
# Flight Agent
# =====================================================
class FlightAgent(ChatAgent):
    def __init__(self):
        super().__init__(
            name="FlightAgent",
            chat_client=FlightChatClient(),
            instructions="""
You are a Flight Agent.
Use structured planner input to search and select flights.
""",
            tools=[flight_search_mcp, flight_booking_mcp],
        )


# =====================================================
# RUN (Planner → Flight)
# =====================================================
async def main():
    planner_output = """
{
  "intent": "travel_planning",
  "origin_city": "New York",
  "destination_city": "San Francisco",
  "date_range": "next month (6 days)",
  "num_travelers": 1,
  "budget": 2500,
  "preferences": {
    "flight_time": "morning"
  },
  "constraints": {
    "trip_type": "business"
  }
}
"""

    agent = FlightAgent()

    response = await agent.run(
        planner_output,
        stream=False,
    )

    print("\n✈️ FLIGHT SELECTION:\n")
    print(response.text)


if __name__ == "__main__":
    asyncio.run(main())
