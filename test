def preprocess_content_chunks(content, max_chunk_len=5000):
    preprocess_chunk = []
    current_paragraph = ""
    current_heading = None
    current_subheading = None
    current_tables = []
    current_image_contexts = []
    tmrc_checklist = None
    last_was_heading = False  # True if last item was a heading/subheading

    def flush_chunk():
        nonlocal current_paragraph, current_tables, current_image_contexts, tmrc_checklist
        if current_paragraph.strip() or current_tables or current_image_contexts or tmrc_checklist:
            chunk = {
                "heading": current_heading,
                "subheading": current_subheading,
                "paragraph": current_paragraph.strip() if current_paragraph.strip() else None,
                "table": current_tables if current_tables else None,
                "image_context": current_image_contexts if current_image_contexts else None,
                "tmrc_checklist": tmrc_checklist if tmrc_checklist else None
            }
            preprocess_chunk.append(chunk)

        # Reset
        current_paragraph = ""
        current_tables = []
        current_image_contexts = []
        tmrc_checklist = None

    for item in content:
        item_type = item.get("type")

        # --- Heading Level 1 ---
        if item_type == "heading" and item.get("level") == 1:
            flush_chunk()
            current_heading = item["text"]
            current_subheading = None
            last_was_heading = True

        # --- Heading Level 2 ---
        elif item_type == "heading" and item.get("level") == 2:
            flush_chunk()
            current_subheading = item["text"]
            last_was_heading = True

        # --- Paragraph ---
        elif item_type == "paragraph":
            text = item.get("text", "").strip()
            if not text:
                continue
            if len(current_paragraph + " " + text) > max_chunk_len:
                flush_chunk()
            current_paragraph += " " + text
            last_was_heading = False

        # --- Table ---
        elif item_type == "table":
            if last_was_heading and tmrc_checklist is None:
                tmrc_checklist = item.get("data", [])
                last_was_heading = False
            else:
                current_tables.append(item.get("data", []))

        # --- Image ---
        elif item_type == "image":
            context = item.get("image_context", "").strip()
            if context:
                current_image_contexts.append(context)
            last_was_heading = False

    flush_chunk()
    return preprocess_chunk
