def preprocess_content_chunks(content, max_chunk_len=5000):
    preprocess_chunk = []
    current_chunk = []
    each_chunk_text = ""
    
    current_heading = None
    current_subheading = None

    def flush_chunk():
        nonlocal each_chunk_text, current_chunk
        if each_chunk_text.strip():
            preprocess_chunk.append({
                "heading": current_heading,
                "subheading": current_subheading,
                "paragraph": each_chunk_text.strip(),
                "children": current_chunk
            })
        each_chunk_text = ""
        current_chunk = []

    for item in content:
        item_type = item.get("type")

        if item_type == "heading" and item.get("level") == 1:
            # New heading → flush everything
            flush_chunk()
            current_heading = item.get("text")
            current_subheading = None
            current_chunk.append(item)

        elif item_type == "heading" and item.get("level") == 2:
            # New subheading → flush previous subheading's chunk
            flush_chunk()
            current_subheading = item.get("text")
            current_chunk.append(item)

        elif item_type in ("paragraph", "table", "image"):
            current_chunk.append(item)
            if item_type == "paragraph" and item.get("text"):
                new_text = item["text"].strip()
                if len(each_chunk_text + " " + new_text) > max_chunk_len:
                    flush_chunk()
                each_chunk_text += " " + new_text

            elif item_type == "image" and item.get("image_context"):
                image_text = item["image_context"].strip()
                if len(each_chunk_text + " " + image_text) > max_chunk_len:
                    flush_chunk()
                each_chunk_text += " " + image_text

    flush_chunk()  # Final flush
    return preprocess_chunk
