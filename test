from fastapi import FastAPI
from datetime import datetime
from pydantic import BaseModel
from typing import Dict, Any

app = FastAPI(title="Travel MCP Server")

# --------------------------------------------------
# MCP Schemas
# --------------------------------------------------
class MCPInvokeRequest(BaseModel):
    name: str
    arguments: Dict[str, Any] | None = None


class MCPInvokeResponse(BaseModel):
    result: Any


# --------------------------------------------------
# Tool Registry
# --------------------------------------------------
def get_time_of_day() -> str:
    hour = datetime.now().hour
    if 5 <= hour < 12:
        return "morning"
    elif 12 <= hour < 17:
        return "afternoon"
    elif 17 <= hour < 21:
        return "evening"
    return "night"


def get_weather(location: str = "Bangalore") -> str:
    return f"The weather in {location} is sunny with light clouds üå§Ô∏è"


TOOLS = {
    "get_time_of_day": {
        "description": "Returns current time of day",
        "function": get_time_of_day,
        "parameters": {},
    },
    "get_weather": {
        "description": "Returns weather for a city",
        "function": get_weather,
        "parameters": {
            "location": {"type": "string", "default": "Bangalore"}
        },
    },
}

# --------------------------------------------------
# MCP Endpoints
# --------------------------------------------------
@app.get("/tools")
def list_tools():
    """MCP: Tool discovery"""
    return {
        "tools": [
            {
                "name": name,
                "description": meta["description"],
                "parameters": meta["parameters"],
            }
            for name, meta in TOOLS.items()
        ]
    }


@app.post("/invoke", response_model=MCPInvokeResponse)
def invoke_tool(request: MCPInvokeRequest):
    """MCP: Tool invocation"""
    if request.name not in TOOLS:
        raise ValueError(f"Tool {request.name} not found")

    func = TOOLS[request.name]["function"]
    args = request.arguments or {}

    result = func(**args)
    return MCPInvokeResponse(result=result)
