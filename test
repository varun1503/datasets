from docx import Document
from docx.text.paragraph import Paragraph
from docx.oxml import OxmlElement
from docx.shared import Pt
from docx.enum.text import WD_COLOR_INDEX
import re, json, ast
import pandas as pd


# ---------- helpers ----------
def _norm(s):
    return re.sub(r"\s+", " ", (s or "")).strip().lower()

def _format_run(run, bold=False, highlight=None):
    run.bold = bool(bold)
    run.font.name = "Times New Roman"
    run.font.size = Pt(11)
    if highlight is not None:
        run.font.highlight_color = highlight

def _insert_after_para(p: Paragraph, text="", bold=False, highlight=None):
    new_p = OxmlElement("w:p")
    p._p.addnext(new_p)
    q = Paragraph(new_p, p._parent)
    if text:
        r = q.add_run(text)
        _format_run(r, bold=bold, highlight=highlight)
    return q

def _delete_range(paragraphs, i_from, i_to):
    if i_from is None or i_to is None or i_from > i_to:
        return
    for k in range(i_to, i_from - 1, -1):
        elm = paragraphs[k]._element
        elm.getparent().remove(elm)

def _safe_dict(x):
    if isinstance(x, dict):
        return x
    if isinstance(x, str):
        s = x.strip()
        if not s:
            return {}
        try:
            return json.loads(s)
        except Exception:
            try:
                return ast.literal_eval(s)
            except Exception:
                return {}
    return {}

def _snum(text):
    m = re.search(r"\bS\s*(\d+)\b", text or "", flags=re.IGNORECASE)
    return f"S{m.group(1)}" if m else ""

def _looks_like_test(p):
    return bool(re.search(r"\btest\b", _norm(p.text)))

def _set_paragraph_text(p: Paragraph, text: str, bold=False):
    for r in p.runs:
        r.text = ""
    r = p.add_run(text)
    _format_run(r, bold=bold, highlight=None)


# ---------- main ----------
def insert_rfr_and_mrmg_with_tags(
    doc_path: str,
    df: pd.DataFrame,
    output_path: str,
    tag_col: str = "text",
    rfr_col: str = "rfr_value",
    mrmg_col: str = "MRMG Assessment ",
    mtr_heading_base: str = "Modelling Team Response",
    highlight_assessment: bool = True,
    assessment_highlight_color=WD_COLOR_INDEX.YELLOW,
    DEBUG=False,
):
    """
    Replace the full MRMG Assessment S# content with the provided text.
    Deletes everything below MRMG Assessment until the next 'Test ...' heading.
    """
    doc = Document(doc_path)

    for _, row in df.iterrows():
        tag = str(row.get(tag_col, "") or "").strip()
        rfr = _safe_dict(row.get(rfr_col, {}))
        mrmg_new = str(row.get(mrmg_col, "") or "").strip()
        if not tag:
            continue

        sn = _snum(tag)
        paras = doc.paragraphs

        # 1. Locate Test section start
        tag_norm = _norm(tag)
        start_idx = next((i for i, p in enumerate(paras) if tag_norm in _norm(p.text)), None)
        if start_idx is None and sn:
            start_idx = next((i for i, p in enumerate(paras) if sn.lower() in _norm(p.text)), None)
        if start_idx is None:
            if DEBUG: print(f"[WARN] Could not find section for tag='{tag}'")
            continue

        # 2. Section end = next "Test ..." or document end
        next_test = None
        for j in range(start_idx + 1, len(paras)):
            if _looks_like_test(paras[j]):
                next_test = j
                break
        section_end = next_test if next_test is not None else len(paras)

        # 3. Find MRMG Assessment heading (with or without S#)
        def _is_assessment_for_sn(p):
            t = _norm(p.text)
            if not t.startswith("mrmg assessment"):
                return False
            return (sn.lower() in t) if sn else True

        mrmg_head_idx = next(
            (i for i in range(start_idx + 1, section_end) if _is_assessment_for_sn(paras[i])),
            None,
        )
        if mrmg_head_idx is None:
            # fallback generic
            mrmg_head_idx = next(
                (i for i in range(start_idx + 1, section_end)
                 if _norm(paras[i].text).startswith("mrmg assessment")),
                None,
            )

        # 4. Replace MRMG Assessment body
        if mrmg_head_idx is not None:
            # Clean heading text (remove colon or inline body)
            head_text = paras[mrmg_head_idx].text.strip()
            m = re.match(r"^(mrmg assessment(?:\s+s?\d+)?)(:.*)?$", head_text, flags=re.IGNORECASE)
            if m:
                pure_heading = m.group(1)
                _set_paragraph_text(paras[mrmg_head_idx], pure_heading, bold=True)

            # Delete EVERYTHING after heading until next Test
            body_start = mrmg_head_idx + 1
            next_test_after = None
            for j in range(body_start, len(paras)):
                if _looks_like_test(paras[j]):
                    next_test_after = j
                    break
            body_end = (next_test_after - 1) if next_test_after is not None else (len(paras) - 1)

            if body_start <= body_end:
                if DEBUG: print(f"[INFO] Deleting {body_start}â€“{body_end} after MRMG {sn}")
                _delete_range(paras, body_start, body_end)
                paras = doc.paragraphs

            # Insert the new MRMG text
            insert_after = paras[mrmg_head_idx]
            new_body_p = _insert_after_para(
                insert_after,
                text=mrmg_new,
                bold=False,
                highlight=(assessment_highlight_color if highlight_assessment else None),
            )
            _insert_after_para(new_body_p, "")  # spacer
            continue

        # 5. If no MRMG heading exists, append one after MTR
        # Find MTR heading
        def _is_mtr(p):
            t = _norm(p.text)
            return "modelling team response" in t or "modeling team response" in t

        mtr_idx = next(
            (i for i in range(start_idx + 1, section_end) if _is_mtr(paras[i])),
            None,
        )
        if mtr_idx is not None:
            anchor = paras[mtr_idx]
            # find end of its body
            j = mtr_idx + 1
            while j < section_end and not _looks_like_test(paras[j]) and not _norm(paras[j].text).startswith("mrmg assessment"):
                j += 1
            anchor = paras[j - 1]
        else:
            anchor = paras[section_end - 1]

        # Insert new MRMG heading + body
        a_head = f"MRMG Assessment {sn}" if sn else "MRMG Assessment"
        h = _insert_after_para(anchor, a_head, bold=True)
        b = _insert_after_para(
            h,
            mrmg_new,
            bold=False,
            highlight=(assessment_highlight_color if highlight_assessment else None),
        )
        _insert_after_para(b, "")

    doc.save(output_path)
