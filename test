import io, csv
import pandas as pd
from pandas.errors import ParserError

def __read_docx_tab(tab, **kwargs):
    vf = io.StringIO()
    writer = csv.writer(vf, quoting=csv.QUOTE_ALL, lineterminator="\n")
    for row in tab.rows:
        writer.writerow([
            cell.text.replace("\r", " ").replace("\n", " ").replace("\xa0", " ").strip()
            for cell in row.cells
        ])
    vf.seek(0)

    try:
        df = pd.read_csv(vf, header=None, engine="c", keep_default_na=False, dtype=str, **kwargs)
    except ParserError as e:
        if getattr(self, "debug", False):
            print(
                f"""Processing table with first 3 rows:
                \n {[cell.text for cell in tab.rows[0].cells]}
                \n {[cell.text for cell in tab.rows[1].cells]}
                \n {[cell.text for cell in tab.rows[2].cells]}"""
            )
            print(f"Table has {len(tab.rows)} rows")
            print(e)
        # fallback to python engine with tolerant parsing
        vf.seek(0)
        df = pd.read_csv(
            vf, header=None, engine="python",
            keep_default_na=False, dtype=str,
            on_bad_lines="skip", **kwargs
        )

    if len(df.columns) == 1:
        return df
    return df
