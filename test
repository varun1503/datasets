def process_row(section_value, mappings, model_doc_filepath):
    """
    Processes one Business cell value
    """

    if pd.isna(section_value):
        return None, None, None, None, "No document section number was provided."

    section_no = str(section_value).strip()
    if section_no == "":
        return None, None, None, None, "No document section number was provided."

    # ---------- resolve sections ----------
    matching_rows = mappings.loc[
        mappings['Section number'] == section_no,
        ['Section number', 'Section Title', 'Section Search']
    ]

    if matching_rows.empty:
        sec_no_lst = split_sections(section_no)

        if sec_no_lst:
            matching_rows = mappings.loc[
                mappings['Section number'].isin(sec_no_lst),
                ['Section number', 'Section Title', 'Section Search']
            ]
        else:
            # fallback: title search
            matching_rows = mappings.loc[
                mappings['Section Title']
                .astype(str)
                .str.contains(section_no, case=False, regex=False, na=False),
                ['Section number', 'Section Title', 'Section Search']
            ]

    if matching_rows.empty:
        return None, None, None, None, f"Section not found: {section_no}"

    # ---------- extraction ----------
    source = ModelDoc(model_doc_filepath)

    extracted_text_all = []
    section_numbers = []
    section_titles = []
    section_search_keys = []

    for _, r in matching_rows.iterrows():
        sec_no = r['Section number']
        sec_title = r['Section Title']
        sec_search = r['Section Search']

        try:
            title, content = source.copy_content(start=sec_search)
            text = extract_text_from_content(content, source._doc.nsmap)

            # include subsections
            subsections = mappings[
                mappings['Section number'].str.startswith(f"{sec_no}.")
            ]['Section Search'].values

            for subsection in subsections:
                sub_title, sub_content = source.copy_content(start=subsection)
                sub_text = extract_text_from_content(sub_content, source._doc.nsmap)
                text += f"\n{sub_title}\n{sub_text}"

            extracted_text_all.append(text)
            section_numbers.append(sec_no)
            section_titles.append(sec_title)
            section_search_keys.append(sec_search)

        except Exception as e:
            return None, None, None, None, f"Error processing section {sec_no}: {e}"

    return (
        section_numbers,
        section_titles,
        section_search_keys,
        "\n\n".join(extracted_text_all),
        None
    )
filepath = r"data\3680Technical_Model_Document_v1"
mappings = get_mappings(filepath)

templatefile = r"data\Pending_items.xlsx"
sample_docs = pd.read_excel(templatefile)

results = sample_docs['Business'].apply(
    lambda v: process_row(v, mappings, filepath)
)

result_df = pd.DataFrame(
    results.tolist(),
    columns=[
        "section_numbers",
        "section_titles",
        "section_search_keys",
        "extracted_text",
        "error"
    ]
)
