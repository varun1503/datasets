import asyncio
import os
import csv
import uuid
import logging
from datetime import datetime

import pandas as pd
from fastmcp import FastMCP

# --------------------------------------------------
# Setup
# --------------------------------------------------
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

mcp = FastMCP("Flight Booking MCP Server ‚úàÔ∏è")

MASTER_FILE = "master_services.csv"
BOOKING_FILE = "flight_bookings.csv"


# --------------------------------------------------
# TOOL 1: SEARCH FLIGHTS
# --------------------------------------------------
@mcp.tool()
def search_flights(
    origin: str,
    destination: str,
    max_price_usd: float = None,
):
    """
    Search flights from master_services.csv
    """
    logger.info("üîç search_flights called")

    if not os.path.exists(MASTER_FILE):
        return []

    df = pd.read_csv(MASTER_FILE)

    # Filter only flights
    df = df[df["service_type"] == "flight"]

    # Apply filters
    if origin:
        df = df[df["origin"].str.lower() == origin.lower()]
    if destination:
        df = df[df["destination"].str.lower() == destination.lower()]
    if max_price_usd is not None:
        df = df[df["price_usd"] <= max_price_usd]

    if df.empty:
        return []

    results = df[
        [
            "service_id",
            "name",
            "origin",
            "destination",
            "provider",
            "price_usd",
            "rating",
            "currency",
        ]
    ].to_dict(orient="records")

    return results


# --------------------------------------------------
# TOOL 2: BOOK FLIGHT
# --------------------------------------------------
@mcp.tool()
def book_flight(
    user_id: str,
    service_id: str,
    origin: str,
    destination: str,
    price_usd: float,
    provider: str,
):
    """
    Simulate flight booking and persist to CSV
    """
    logger.info("‚úàÔ∏è book_flight called")

    trip_id = f"TRIP-{uuid.uuid4().hex[:8].upper()}"

    booking = {
        "trip_id": trip_id,
        "user_id": user_id,
        "service_type": "flight",
        "service_id": service_id,
        "origin": origin,
        "destination": destination,
        "price_usd": price_usd,
        "provider": provider,
        "currency": "USD",
        "status": "BOOKED",
        "booked_at": datetime.utcnow().isoformat(),
    }

    file_exists = os.path.exists(BOOKING_FILE)

    with open(BOOKING_FILE, "a", newline="") as f:
        writer = csv.DictWriter(f, fieldnames=booking.keys())
        if not file_exists:
            writer.writeheader()
        writer.writerow(booking)

    return booking


# --------------------------------------------------
# RUN SERVER
# --------------------------------------------------
if __name__ == "__main__":
    port = int(os.getenv("PORT", 8006))
    logger.info(f"üöÄ Flight MCP server running on port {port}")

    asyncio.run(
        mcp.run_async(
            transport="http",
            host="0.0.0.0",
            port=port,
        )
    )
