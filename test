from docx import Document
from docx.text.paragraph import Paragraph
from docx.oxml import OxmlElement
from docx.shared import Pt
from docx.enum.text import WD_COLOR_INDEX
import re, json, ast
import pandas as pd

# ---------- helpers ----------
def _norm(s):
    return re.sub(r"\s+", " ", (s or "")).strip().lower()

def _format_run(run, bold=False, highlight=None):
    run.bold = bool(bold)
    run.font.name = "Times New Roman"
    run.font.size = Pt(11)
    if highlight is not None:
        run.font.highlight_color = highlight

def _insert_after_para(p: Paragraph, text="", bold=False, highlight=None):
    """Insert a paragraph AFTER p with Times New Roman 11."""
    new_p = OxmlElement("w:p")
    p._p.addnext(new_p)
    q = Paragraph(new_p, p._parent)
    if text:
        r = q.add_run(text)
        _format_run(r, bold=bold, highlight=highlight)
    return q

def _delete_range(paragraphs, i_from, i_to):
    if i_from is None or i_to is None or i_from > i_to:
        return
    for k in range(i_to, i_from - 1, -1):
        elm = paragraphs[k]._element
        elm.getparent().remove(elm)

def _safe_dict(x):
    if isinstance(x, dict):
        return x
    if isinstance(x, str):
        s = x.strip()
        if not s:
            return {}
        try:
            return json.loads(s)
        except Exception:
            try:
                return ast.literal_eval(s)
            except Exception:
                return {}
    return {}

def _snum(text):  # returns like "S2" if present, else ""
    m = re.search(r"\bS\s*(\d+)\b", text or "", flags=re.IGNORECASE)
    return f"S{m.group(1)}" if m else ""

def _looks_like_test(p):
    return bool(re.search(r"\btest\b", _norm(p.text)))

# --- stronger heading detection ---
_HEADING_KEYWORDS = [
    "challenge",
    "modelling team response",
    "modeling team response",
    "mrmg assessment",
    "mrmg evaluation",
    "finding details",
    "findings details",
    "limitations and control",
    "limitation and control",
    "validation assessment details",
    "table of contents",
    "test",
    "section",
    "appendix",
    "references",
]

def _is_heading_text_norm(tnorm: str) -> bool:
    if not tnorm:
        return False
    # keyword-led headings
    if any(tnorm.startswith(k) for k in _HEADING_KEYWORDS):
        return True
    # ALL CAPS short lines (common heading pattern)
    if tnorm.replace(" ", "").isalpha():
        # original text (non-lowered) might be all caps; heuristic:
        tokens = tnorm.split()
        if 0 < len(tokens) <= 12 and tnorm == tnorm.upper():
            return True
    # Lines ending with ":" and short
    if tnorm.endswith(":") and len(tnorm) <= 80:
        return True
    return False

def _is_heading_para(p: Paragraph) -> bool:
    tnorm = _norm(p.text)
    # 1) Style-based: any Word style containing "Heading"
    try:
        if p.style and "heading" in (p.style.name or "").strip().lower():
            return True
    except Exception:
        pass
    # 2) Keyword / shape-based
    if _is_heading_text_norm(tnorm):
        return True
    # 3) Bold-short heuristic: mostly heading lines are bold & short
    if len(p.text.strip()) > 0 and len(p.text.strip()) <= 120:
        for r in p.runs:
            if r.bold:
                return True
    return False

def _find_idx_in_range(paras, start, end, predicate):
    for i in range(start, min(end, len(paras))):
        if predicate(paras[i]):
            return i
    return None

# ---------- main ----------
def insert_rfr_and_mrmg_with_tags(
    doc_path: str,
    df: pd.DataFrame,
    output_path: str,
    tag_col: str = "text",                  # e.g., "Test S1"
    rfr_col: str = "rfr_value",             # dict: {<challenge text>: <model team response>}
    mrmg_col: str = "MRMG Assessment ",     # as in your sheet (trailing space)
    mtr_heading_base: str = "Modelling Team Response",
    highlight_assessment: bool = True,
    assessment_highlight_color=WD_COLOR_INDEX.YELLOW,
):
    """
    On finding 'MRMG Assessment [S#]' heading:
      → DELETE EVERYTHING until the next heading (2–3+ paragraphs, blanks, etc.)
      → Insert one clean body paragraph from df[mrmg_col].

    Also preserves adjacency of 'Modelling/Modeling Team Response' heading and its body.
    """
    doc = Document(doc_path)

    for _, row in df.iterrows():
        tag = str(row.get(tag_col, "") or "").strip()
        rfr = _safe_dict(row.get(rfr_col, {}))
        mrmg_new = str(row.get(mrmg_col, "") or "").strip()
        if not tag:
            continue

        sn = _snum(tag)  # "S1", "S2", ...
        paras = doc.paragraphs

        # 1) locate section start by exact tag or S#
        tag_norm = _norm(tag)
        start_idx = next((i for i, p in enumerate(paras) if tag_norm in _norm(p.text)), None)
        if start_idx is None and sn:
            start_idx = next((i for i, p in enumerate(paras) if sn.lower() in _norm(p.text)), None)
        if start_idx is None:
            continue

        # 2) section end = next "Test ..." or doc end
        next_test = None
        for j in range(start_idx + 1, len(paras)):
            if _looks_like_test(paras[j]):
                next_test = j
                break
        section_end = next_test if next_test is not None else len(paras)

        # 3) find MTR heading (any spelling)
        def _is_mtr(p):
            t = _norm(p.text)
            return ("modelling team response" in t) or ("modeling team response" in t)

        mtr_idx = _find_idx_in_range(paras, start_idx + 1, section_end, _is_mtr)

        # 4) find MRMG Assessment heading for this S# (prefer exact S#, else any in section)
        def _is_assessment_for_sn(p):
            t = _norm(p.text)
            if not t.startswith("mrmg assessment"):
                return False
            return (sn.lower() in t) if sn else True

        mrmg_head_idx = _find_idx_in_range(paras, start_idx + 1, section_end, _is_assessment_for_sn)
        if mrmg_head_idx is None:
            mrmg_head_idx = _find_idx_in_range(paras, start_idx + 1, section_end,
                                               lambda p: _norm(p.text).startswith("mrmg assessment"))

        # 5) REPLACE MRMG Assessment body: remove ALL until next heading
        if mrmg_head_idx is not None:
            # body starts after heading
            body_start = mrmg_head_idx + 1

            # find next heading within section (style-, bold-, or keyword-based)
            next_head = _find_idx_in_range(paras, body_start, section_end, _is_heading_para)

            # If no heading found, consume to end of section
            body_end = (next_head - 1) if next_head is not None else (section_end - 1)

            # Delete everything in [body_start, body_end], including blanks
            if body_start <= body_end:
                _delete_range(paras, body_start, body_end)
                paras = doc.paragraphs  # refresh after deletion

            # Insert new body AFTER heading
            insert_after = doc.paragraphs[mrmg_head_idx]
            new_body_p = _insert_after_para(
                insert_after,
                text=mrmg_new,
                bold=False,
                highlight=(assessment_highlight_color if highlight_assessment else None),
            )
            _insert_after_para(new_body_p, "")  # spacer
            continue  # for this row we’re done

        # 6) If no MRMG Assessment heading: preserve MTR adjacency, then add heading + body
        # Find end of MTR body (walk until next detected heading)
        anchor_after = None
        if mtr_idx is not None:
            i = mtr_idx + 1
            while i < section_end and not _is_heading_para(paras[i]):
                i += 1
            anchor_after = paras[i - 1] if i > (mtr_idx + 1) else paras[mtr_idx]
        else:
            anchor_after = paras[section_end - 1] if section_end - 1 >= start_idx else paras[start_idx]

        # Optional: insert RFR pairs AFTER anchor (never between MTR heading & body)
        if rfr:
            cur = anchor_after
            for ch_text, resp_text in rfr.items():
                ch_head = f"Challenge {sn}" if sn else "Challenge"
                mtr_head = f"{mtr_heading_base} {sn}" if sn else mtr_heading_base

                cur = _insert_after_para(cur, ch_head, bold=True)
                cur = _insert_after_para(cur, str(ch_text or "").strip(), bold=False)

                cur = _insert_after_para(cur, mtr_head, bold=True)
                cur = _insert_after_para(cur, str(resp_text or "").strip(), bold=False)

                cur = _insert_after_para(cur, "")
            anchor_after = cur

        # Now add MRMG Assessment heading + body
        if mrmg_new:
            a_head = f"MRMG Assessment {sn}" if sn else "MRMG Assessment"
            h = _insert_after_para(anchor_after, a_head, bold=True)
            b = _insert_after_para(
                h,
                mrmg_new,
                bold=False,
                highlight=(assessment_highlight_color if highlight_assessment else None),
            )
            _insert_after_para(b, "")

    doc.save(output_path)
