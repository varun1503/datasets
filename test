def preprocess_content_chunks(content, max_chunk_len=5000):
    preprocess_chunk = []
    current_paragraph = ""
    
    current_heading = None
    current_subheading = None
    current_table = None
    current_image_context = None

    def flush_chunk():
        nonlocal current_paragraph, current_table, current_image_context
        if current_paragraph.strip():
            preprocess_chunk.append({
                "heading": current_heading,
                "subheading": current_subheading,
                "paragraph": current_paragraph.strip(),
                "table": current_table,
                "image_context": current_image_context
            })
        # reset chunk variables
        current_paragraph = ""
        current_table = None
        current_image_context = None

    for item in content:
        item_type = item.get("type")

        # --- Handle heading (level 1) ---
        if item_type == "heading" and item.get("level") == 1:
            flush_chunk()
            current_heading = item["text"]
            current_subheading = None

        # --- Handle subheading (level 2) ---
        elif item_type == "heading" and item.get("level") == 2:
            flush_chunk()
            current_subheading = item["text"]

        # --- Handle paragraph ---
        elif item_type == "paragraph":
            text = item.get("text", "").strip()
            if not text:
                continue  # skip empty paragraphs
            if len(current_paragraph + " " + text) > max_chunk_len:
                flush_chunk()
            current_paragraph += " " + text

        # --- Handle table ---
        elif item_type == "table":
            if current_table is not None:
                flush_chunk()
            current_table = item["data"]

        # --- Handle image with context ---
        elif item_type == "image":
            context = item.get("image_context", "").strip()
            if not context:
                continue
            if current_image_context is not None:
                flush_chunk()
            current_image_context = context

    flush_chunk()  # Final flush

    return preprocess_chunk
