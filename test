# =========================================================
# JUPYTER NOTEBOOK ‚Äì model("3") + ChatPromptValue + ChatAgent
# =========================================================

import asyncio
from typing import List

from langchain_core.prompts import ChatPromptTemplate
from langchain_core.prompt_values import ChatPromptValue

from agent_framework import ChatAgent
from agent_framework.messages import ChatMessage, Role


# =========================================================
# YOUR MODEL FACTORY (ORG STANDARD)
# =========================================================
def model(version: str):
    """
    Factory that returns your custom LLM.
    This matches: llm = model("3")
    """
    return MyCustomLLM(version)


# =========================================================
# YOUR CUSTOM LLM (ChatPromptValue ONLY)
# =========================================================
class MyCustomLLM:
    def __init__(self, version: str):
        self.version = version

    def invoke(self, prompt_value: ChatPromptValue) -> ChatMessage:
        print(f"\nüîµ LLM v{self.version} INVOKED WITH ChatPromptValue\n")
        print(prompt_value.to_string())

        return ChatMessage(
            role=Role.ASSISTANT,
            content="Hello üëã (generated by model('3'))"
        )


# =========================================================
# CUSTOM CHAT CLIENT (KEY INTEGRATION POINT)
# =========================================================
class MyChatClient:
    """
    This is where:
    llm = model("3")
    llm.invoke(prompt_value)
    happens.
    """

    def __init__(self):
        pass

    async def invoke(
        self,
        messages: List[ChatMessage],
        *,
        tools=None,
        **kwargs,
    ) -> ChatMessage:

        # 1Ô∏è‚É£ Convert ChatMessages ‚Üí ChatPromptTemplate
        prompt_template = ChatPromptTemplate.from_messages(
            [(m.role, m.content) for m in messages]
        )

        # 2Ô∏è‚É£ Convert ‚Üí ChatPromptValue
        prompt_value = prompt_template.format_prompt()

        # 3Ô∏è‚É£ EXACT LINE YOU ASKED FOR
        llm = model("3")

        # 4Ô∏è‚É£ EXACT CALL YOU WANT
        response_message = llm.invoke(prompt_value)

        return response_message


# =========================================================
# GREETING AGENT
# =========================================================
class GreetingAgent(ChatAgent):
    def __init__(self):
        super().__init__(
            name="GreetingAgent",
            chat_client=MyChatClient(),
            instructions="You are a friendly greeting assistant.",
        )


# =========================================================
# RUN
# =========================================================
async def main():
    agent = GreetingAgent()
    response = await agent.run("Hi")
    print("\nüü¢ FINAL RESPONSE:")
    print(response)

await main()
