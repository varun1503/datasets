from docx import Document
from docx.oxml import parse_xml
import re

def is_table_caption(text):
    """Check if text starts with 'Table' followed by a number"""
    if not text or len(text.strip()) > 300:
        return False
    # Must start with "Table" (case-insensitive)
    return bool(re.match(r'^\s*Table\s+[\d.]+', text.strip(), re.IGNORECASE))

def is_figure_caption(text):
    """Check if text starts with 'Figure' followed by a number"""
    if not text or len(text.strip()) > 300:
        return False
    # Must start with "Figure" (case-insensitive)
    return bool(re.match(r'^\s*Figure\s+[\d.]+', text.strip(), re.IGNORECASE))

def renumber_captions(doc_path, output_path):
    """
    Renumber all table and figure captions sequentially
    Move captions that are below tables to above them
    Add captions where missing
    """
    doc = Document(doc_path)
    body = doc.element.body
    elements = list(body)

    # Step 1: Move table captions from below to above
    for i, element in enumerate(elements):
        if element.tag.endswith('tbl'):
            # Check if next element is a caption
            next_element = elements[i + 1] if i + 1 < len(elements) else None

            if next_element is not None and next_element.tag.endswith('p'):
                # Find the paragraph
                for para in doc.paragraphs:
                    if para._element == next_element:
                        text = para.text.strip()
                        # Check if it's a table caption (MUST START WITH "Table")
                        if is_table_caption(text):
                            # Move caption from after table to before table
                            next_element.getparent().remove(next_element)
                            element.addprevious(next_element)
                            print(f"✓ Moved caption to top: {text[:50]}...")
                        break

    # Step 2: Add missing captions for tables
    doc.save(output_path)
    doc = Document(output_path)
    body = doc.element.body
    elements = list(body)

    for i, element in enumerate(elements):
        if element.tag.endswith('tbl'):
            # Check if previous element is a caption
            prev_element = elements[i - 1] if i > 0 else None
            has_caption = False

            if prev_element is not None and prev_element.tag.endswith('p'):
                for para in doc.paragraphs:
                    if para._element == prev_element:
                        if is_table_caption(para.text):
                            has_caption = True
                        break

            # Add caption if missing
            if not has_caption:
                new_para = parse_xml(r'<w:p xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:r><w:t>Table PLACEHOLDER {}</w:t></w:r></w:p>')
                element.addprevious(new_para)
                print(f"✓ Added missing table caption")

    # Step 3: Move figure captions from below to above (if needed)
    doc.save(output_path)
    doc = Document(output_path)
    body = doc.element.body
    elements = list(body)

    for i, element in enumerate(elements):
        if element.tag.endswith('p'):
            # Check if paragraph contains an image
            current_para = None
            for para in doc.paragraphs:
                if para._element == element:
                    current_para = para
                    break

            if current_para:
                has_image = any(run._element.xpath('.//pic:pic') for run in current_para.runs)

                if has_image:
                    # Check if next paragraph is a figure caption
                    next_element = elements[i + 1] if i + 1 < len(elements) else None

                    if next_element is not None and next_element.tag.endswith('p'):
                        for para in doc.paragraphs:
                            if para._element == next_element:
                                text = para.text.strip()
                                # Check if it STARTS with "Figure"
                                if is_figure_caption(text):
                                    # Move caption from after image to before image
                                    next_element.getparent().remove(next_element)
                                    element.addprevious(next_element)
                                    print(f"✓ Moved figure caption to top: {text[:50]}...")
                                break

    # Step 4: Add missing captions for figures
    doc.save(output_path)
    doc = Document(output_path)
    body = doc.element.body
    elements = list(body)

    for i, element in enumerate(elements):
        if element.tag.endswith('p'):
            current_para = None
            for para in doc.paragraphs:
                if para._element == element:
                    current_para = para
                    break

            if current_para:
                has_image = any(run._element.xpath('.//pic:pic') for run in current_para.runs)
                if has_image:
                    # Check for existing caption (should be before now)
                    prev_element = elements[i - 1] if i > 0 else None
                    has_caption = False
                    if prev_element is not None and prev_element.tag.endswith('p'):
                        for para in doc.paragraphs:
                            if para._element == prev_element:
                                if is_figure_caption(para.text):
                                    has_caption = True
                                break

                    if not has_caption:
                        new_para = parse_xml(r'<w:p xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:r><w:t>Figure PLACEHOLDER {}</w:t></w:r></w:p>')
                        element.addprevious(new_para)
                        print(f"✓ Added missing figure caption")

    # Step 5: Renumber all captions
    doc.save(output_path)
    doc = Document(output_path)
    body = doc.element.body
    elements = list(body)

    table_num = 1
    figure_num = 1

    for i, element in enumerate(elements):
        if element.tag.endswith('p'):
            current_para = None
            for para in doc.paragraphs:
                if para._element == element:
                    current_para = para
                    break

            if current_para:
                text = current_para.text.strip()

                # Check if this is a table caption (followed by table)
                next_element = elements[i + 1] if i + 1 < len(elements) else None

                if is_table_caption(text) or re.match(r'^\s*Table\s+PLACEHOLDER', text, re.IGNORECASE):
                    if next_element is not None and next_element.tag.endswith('tbl'):
                        # Extract description
                        match = re.match(r'^\s*Table\s+(?:PLACEHOLDER|[\d.]+):?\s*(.*)', text, re.IGNORECASE)
                        description = match.group(1).strip() if match else ''

                        if not description:
                            current_para.text = f'Table {table_num}'
                        else:
                            current_para.text = f'Table {table_num}: {description}'
                        
                        table_num += 1
                        print(f"✓ Renumbered: {current_para.text[:50]}...")

                # Check if this is a figure caption (followed by image)
                if is_figure_caption(text) or re.match(r'^\s*Figure\s+PLACEHOLDER', text, re.IGNORECASE):
                    if next_element is not None and next_element.tag.endswith('p'):
                        # Check if next paragraph has image
                        for para in doc.paragraphs:
                            if para._element == next_element:
                                has_image = any(run._element.xpath('.//pic:pic') for run in para.runs)
                                if has_image:
                                    # Extract description
                                    match = re.match(r'^\s*Figure\s+(?:PLACEHOLDER|[\d.]+):?\s*(.*)', text, re.IGNORECASE)
                                    description = match.group(1).strip() if match else ''

                                    if not description:
                                        current_para.text = f'Figure {figure_num}'
                                    else:
                                        current_para.text = f'Figure {figure_num}: {description}'
                                    
                                    figure_num += 1
                                    print(f"✓ Renumbered: {current_para.text[:50]}...")
                                break

    doc.save(output_path)

    print(f"\n✓ Document processed successfully!")
    print(f"✓ Table captions: {table_num - 1}")
    print(f"✓ Figure captions: {figure_num - 1}")
    print(f"✓ All captions moved to top and renumbered")
    print(f"✓ Saved to: {output_path}")


# Usage
if __name__ == "__main__":
    input_file = "buisness.docx"
    output_file = "buisness_renumbered.docx"
    renumber_captions(input_file, output_file)
