# =========================================================
# JUPYTER NOTEBOOK â€“ GREETING AGENT WITH MULTIPLE TOOLS
# =========================================================

import asyncio
from datetime import datetime
from typing import Sequence, Any, MutableMapping, Callable, AsyncIterable

from langchain_core.prompts import ChatPromptTemplate
from safechain.lcel import model

from agent_framework import ChatAgent, BaseChatClient
from agent_framework import ChatMessage, Role, TextContent
from agent_framework import ChatResponse, ToolProtocol


# =========================================================
# SAFE TEXT EXTRACTION (YOUR FRAMEWORK VERSION)
# =========================================================
def extract_text_from_message(m: ChatMessage) -> str:
    if hasattr(m, "contents") and m.contents:
        c = m.contents[0]
        if hasattr(c, "text"):
            return c.text
        if hasattr(c, "value"):
            return c.value
        if hasattr(c, "data"):
            return c.data
    return ""


# =========================================================
# TOOL 1: TIME OF DAY
# =========================================================
class TimeOfDayTool(ToolProtocol):
    name = "get_time_of_day"
    description = "Returns current time of day: morning, afternoon, evening, night"

    def __call__(self) -> str:
        hour = datetime.now().hour
        if 5 <= hour < 12:
            return "morning"
        elif 12 <= hour < 17:
            return "afternoon"
        elif 17 <= hour < 21:
            return "evening"
        else:
            return "night"


# =========================================================
# TOOL 2: WEATHER
# =========================================================
class WeatherTool(ToolProtocol):
    name = "get_weather"
    description = "Returns current weather condition for a city"

    def __call__(self, location: str = "Bangalore") -> str:
        # Mocked weather (replace with API later)
        return f"The weather in {location} is sunny with light clouds ðŸŒ¤ï¸"


# =========================================================
# PROMPT
# =========================================================
def greetings_prompt(user_input: str, time_of_day: str, weather: str) -> str:
    return f"""
You are a friendly, polite greeting assistant.

Time of day: {time_of_day}
Weather info: {weather}

Greet the user appropriately using the time and weather.

User input:
{user_input}

Keep the response short and friendly.
"""


# =========================================================
# CHAT CLIENT (MULTI-TOOL AWARE)
# =========================================================
class MyChatClient(BaseChatClient):

    async def _inner_get_response(
        self,
        messages: Sequence[ChatMessage],
        *,
        tools: Sequence[ToolProtocol] | None = None,
        tool_choice: Callable[..., Any] | None = None,
        chat_options: MutableMapping[str, Any] | None = None,
        **kwargs: Any,
    ) -> ChatResponse:

        # -------------------------------------------------
        # TOOL RESOLUTION (LIST OF TOOLS)
        # -------------------------------------------------
        time_of_day = "day"
        weather_info = "Weather unavailable"

        if tools:
            for tool in tools:
                if tool.name == "get_time_of_day":
                    time_of_day = tool()
                elif tool.name == "get_weather":
                    weather_info = tool("Bangalore")

        # -------------------------------------------------
        # PROMPT BUILDING
        # -------------------------------------------------
        prompt_template = ChatPromptTemplate.from_messages(
            [
                (
                    m.role.value,
                    greetings_prompt(
                        extract_text_from_message(m),
                        time_of_day=time_of_day,
                        weather=weather_info,
                    )
                )
                for m in messages
            ]
        )

        prompt_value = prompt_template.format_prompt()

        # -------------------------------------------------
        # SAFECHAIN MODEL CALL
        # -------------------------------------------------
        llm = model("3")
        llm_response = llm.invoke(prompt_value)

        response_message = ChatMessage(
            role=Role.ASSISTANT,
            contents=[TextContent(text=llm_response.content)],
        )

        return ChatResponse(messages=response_message)

    async def _inner_get_streaming_response(
        self,
        messages: Sequence[ChatMessage],
        *,
        tools: Sequence[ToolProtocol] | None = None,
        tool_choice: Callable[..., Any] | None = None,
        chat_options: MutableMapping[str, Any] | None = None,
        **kwargs: Any,
    ) -> AsyncIterable[ChatResponse]:
        raise NotImplementedError("Streaming not implemented")


# =========================================================
# GREETING AGENT (PASS TOOLS AS LIST)
# =========================================================
class GreetingAgent(ChatAgent):
    def __init__(self):
        super().__init__(
            name="GreetingAgent",
            chat_client=MyChatClient(),
            instructions="You are a friendly greeting assistant.",
            tools=[
                TimeOfDayTool(),
                WeatherTool(),
            ],  # ðŸ‘ˆ LIST OF TOOLS (OFFICIAL STYLE)
        )


# =========================================================
# RUN
# =========================================================
async def main():
    agent = GreetingAgent()
    response = await agent.run("Hi")

    print("\nðŸŸ¢ FINAL RESPONSE:\n")
    print(response.messages.contents[0].text)

await main()
