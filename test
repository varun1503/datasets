import asyncio
import json
from typing import Sequence, Any

from agent_framework import (
    ChatAgent,
    BaseChatClient,
    ChatMessage,
    ChatResponse,
    Role,
    TextContent,
)

from safechain.lcel import model


# =====================================================
# Helper
# =====================================================
def extract_text_from_message(m: ChatMessage) -> str:
    if m.contents:
        return getattr(m.contents[0], "text", "")
    return ""


# =====================================================
# FEW-SHOT PLANNER PROMPT
# =====================================================
def planner_prompt(user_query: str) -> str:
    return f"""
You are a travel planning assistant.

Your task is to extract structured travel planning information
from a user query and return ONLY valid JSON.

‚ùó Rules:
- Output MUST be valid JSON
- Do NOT add explanations
- Use null if information is missing

JSON Schema:
{{
  "intent": string,
  "origin_city": string | null,
  "destination_city": string | null,
  "date_range": string | null,
  "num_travelers": number | null,
  "budget": number | null,
  "preferences": object,
  "constraints": object
}}

### Example 1
User:
Plan a 5-day leisure trip from Delhi to Goa for 2 people under $1500.

Output:
{{
  "intent": "travel_planning",
  "origin_city": "Delhi",
  "destination_city": "Goa",
  "date_range": "5 days",
  "num_travelers": 2,
  "budget": 1500,
  "preferences": {{}},
  "constraints": {{
    "trip_type": "leisure"
  }}
}}

### Example 2
User:
Book a business trip from New York to San Francisco next month.
Morning flights and 4-star hotel. Budget $2500.

Output:
{{
  "intent": "travel_planning",
  "origin_city": "New York",
  "destination_city": "San Francisco",
  "date_range": "next month",
  "num_travelers": 1,
  "budget": 2500,
  "preferences": {{
    "flight_time": "morning",
    "hotel_rating": "4-star"
  }},
  "constraints": {{
    "trip_type": "business"
  }}
}}

### Now extract for this user query.

User:
{user_query}

Output ONLY valid JSON.
"""


# =====================================================
# Planner Chat Client (NO TOOLS)
# =====================================================
class PlannerChatClient(BaseChatClient):

    async def _inner_get_response(
        self,
        messages: Sequence[ChatMessage],
        **kwargs: Any,
    ) -> ChatResponse:

        user_query = extract_text_from_message(messages[-1])

        prompt = planner_prompt(user_query)

        llm = model("3")
        result = llm.invoke(prompt)

        # Optional: validate JSON (safe guard)
        try:
            json.loads(result.content)
            output_text = result.content
        except Exception:
            output_text = json.dumps(
                {"error": "Invalid JSON output from model"},
                indent=2
            )

        return ChatResponse(
            messages=ChatMessage(
                role=Role.ASSISTANT,
                contents=[TextContent(text=output_text)],
            )
        )

    async def _inner_get_streaming_response(self, *args, **kwargs):
        raise NotImplementedError("Streaming not supported")


# =====================================================
# Planner Agent
# =====================================================
class PlannerAgent(ChatAgent):
    def __init__(self):
        super().__init__(
            name="PlannerAgent",
            chat_client=PlannerChatClient(),
            instructions="""
You are a Planner Agent.
Extract structured intent and travel slots from user queries.
""",
            tools=[],  # ‚ùå NO TOOLS
        )


# =====================================================
# Run
# =====================================================
async def main():
    agent = PlannerAgent()

    response = await agent.run(
        "Plan a 6-day business trip from New York to San Francisco next month for 1 traveler. "
        "I need morning flights, a 4-star hotel near the financial district, "
        "and cabs for airport transfers and office commutes. "
        "Keep the total budget under $2,500.",
        stream=False,
    )

    print("\nüß† PLANNER OUTPUT (STRUCTURED JSON):\n")
    print(response.text)


if __name__ == "__main__":
    asyncio.run(main())
