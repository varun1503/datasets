from docx import Document
from docx.oxml import parse_xml
import re

# =========================================================
# GLOBAL PLACEHOLDER REGEX (SINGLE SOURCE OF TRUTH)
# =========================================================
PLACEHOLDER_REGEX = re.compile(
    r'[\[\{\(]?\s*'
    r'(put|insert)?\s*'
    r'(model(?:l?ing)?\s*team\'?s?|team\'?s?)?\s*'
    r'response\s*here'
    r'\s*[\]\}\)]?',
    re.IGNORECASE
)

# =========================================================
# CAPTION HELPERS
# =========================================================
def looks_like_caption(text):
    return bool(re.match(r'^\s*(Table|Figure)\s+[\d.]+', text, re.IGNORECASE))

def is_actual_caption(text, next_element_is_table_or_image=True):
    text = text.strip()

    if not next_element_is_table_or_image:
        return False

    if not re.match(r'^\s*(Table|Figure)\s+([\d.]+|PLACEHOLDER)', text, re.IGNORECASE):
        return False

    descriptive_phrases = [
        r'is provided below',
        r'is shown below',
        r'are provided below',
        r'are shown below',
        r'which underwent',
        r'for .+ is provided',
        r'for .+ is shown'
    ]

    for phrase in descriptive_phrases:
        if re.search(phrase, text, re.IGNORECASE):
            return False

    if len(text) > 200:
        return False

    return True

def is_empty_paragraph(para):
    return not para.text.strip()

# =========================================================
# PLACEHOLDER REMOVAL
# =========================================================
def contains_placeholder_text(text):
    return bool(PLACEHOLDER_REGEX.search(text))

def clean_placeholder_text_from_runs(para):
    full_text = para.text
    if not contains_placeholder_text(full_text):
        return False

    new_text = PLACEHOLDER_REGEX.sub('', full_text)
    new_text = re.sub(r'\s+', ' ', new_text).strip()

    for run in para.runs:
        run.text = ''

    if new_text:
        para.add_run(new_text)

    return True

def remove_placeholder_paragraphs(doc):
    to_remove = []

    for para in doc.paragraphs:
        if para.text.strip() and contains_placeholder_text(para.text):
            to_remove.append(para)

    for para in to_remove:
        para._element.getparent().remove(para._element)

    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for para in list(cell.paragraphs):
                    if para.text.strip() and contains_placeholder_text(para.text):
                        para._element.getparent().remove(para._element)

def remove_all_placeholders(doc):
    remove_placeholder_paragraphs(doc)

    for para in doc.paragraphs:
        clean_placeholder_text_from_runs(para)

    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for para in cell.paragraphs:
                    clean_placeholder_text_from_runs(para)

# =========================================================
# CAPTION MOVEMENT LOGIC (ROBUST)
# =========================================================
def find_and_move_captions_below_tables(doc):
    body = doc.element.body
    elements = list(body)
    moved = 0

    i = 0
    while i < len(elements):
        element = elements[i]

        if element.tag.endswith('tbl'):
            has_caption_before = False

            if i > 0 and elements[i - 1].tag.endswith('p'):
                for p in doc.paragraphs:
                    if p._element == elements[i - 1] and looks_like_caption(p.text):
                        has_caption_before = True
                        break

            if not has_caption_before:
                for offset in range(1, 21):
                    if i + offset >= len(elements):
                        break

                    nxt = elements[i + offset]

                    if nxt.tag.endswith('tbl'):
                        break

                    if nxt.tag.endswith('p'):
                        for p in doc.paragraphs:
                            if p._element == nxt:
                                if re.match(r'^\s*Table\s+[\d.]+', p.text, re.IGNORECASE):
                                    nxt.getparent().remove(nxt)
                                    element.addprevious(nxt)
                                    elements = list(body)
                                    moved += 1
                                break
        i += 1

    return moved

def find_and_move_captions_below_figures(doc):
    body = doc.element.body
    elements = list(body)
    moved = 0

    i = 0
    while i < len(elements):
        element = elements[i]

        if element.tag.endswith('p'):
            para = next((p for p in doc.paragraphs if p._element == element), None)
            if not para:
                i += 1
                continue

            has_image = any(run._element.xpath('.//pic:pic') for run in para.runs)

            if has_image:
                has_caption_before = False

                if i > 0 and elements[i - 1].tag.endswith('p'):
                    for p in doc.paragraphs:
                        if p._element == elements[i - 1] and looks_like_caption(p.text):
                            has_caption_before = True
                            break

                if not has_caption_before:
                    for offset in range(1, 21):
                        if i + offset >= len(elements):
                            break

                        nxt = elements[i + offset]

                        if nxt.tag.endswith('tbl'):
                            break

                        if nxt.tag.endswith('p'):
                            for p in doc.paragraphs:
                                if p._element == nxt:
                                    if any(run._element.xpath('.//pic:pic') for run in p.runs):
                                        break
                                    if re.match(r'^\s*Figure\s+[\d.]+', p.text, re.IGNORECASE):
                                        nxt.getparent().remove(nxt)
                                        element.addprevious(nxt)
                                        elements = list(body)
                                        moved += 1
                                    break
        i += 1

    return moved

# =========================================================
# CLEAN EMPTY PARAGRAPHS BETWEEN CAPTION & CONTENT
# =========================================================
def remove_empty_paragraphs_between_caption_and_content(doc):
    body = doc.element.body
    elements = list(body)
    to_remove = []

    for i, el in enumerate(elements):
        if el.tag.endswith('p'):
            para = next((p for p in doc.paragraphs if p._element == el), None)
            if not para:
                continue

            if looks_like_caption(para.text):
                j = i + 1
                while j < len(elements):
                    nxt = elements[j]

                    if nxt.tag.endswith('tbl'):
                        break

                    if nxt.tag.endswith('p'):
                        p2 = next((p for p in doc.paragraphs if p._element == nxt), None)
                        if p2 and is_empty_paragraph(p2):
                            to_remove.append(p2)
                        else:
                            break
                    j += 1

    for p in to_remove:
        p._element.getparent().remove(p._element)

# =========================================================
# MAIN ENTRY
# =========================================================
def renumber_captions(doc_path, output_path):
    doc = Document(doc_path)

    find_and_move_captions_below_tables(doc)
    doc.save(output_path)

    doc = Document(output_path)
    find_and_move_captions_below_figures(doc)
    doc.save(output_path)

    doc = Document(output_path)
    remove_empty_paragraphs_between_caption_and_content(doc)
    doc.save(output_path)

    doc = Document(output_path)
    remove_all_placeholders(doc)
    doc.save(output_path)
if __name__ == "__main__":
    input_docx = "input.docx"      # your original file
    output_docx = "output.docx"    # cleaned file

    renumber_captions(input_docx, output_docx)
    print("Done. Cleaned file saved as:", output_docx)
