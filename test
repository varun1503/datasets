from docx import Document
from docx.oxml.ns import qn
from docx.text.paragraph import Paragraph
import os

# WordprocessingML namespace
NSMAP = {'w': 'http://schemas.openxmlformats.org/wordprocessingml/2006/main'}

def get_cell_text(cell):
    """Extracts clean text from a table cell (avoiding duplicated values)."""
    paragraphs = [Paragraph(p, None).text.strip() for p in cell.findall('.//w:p', namespaces=NSMAP)]
    return ' '.join(p for p in paragraphs if p)

def extract_ordered_docx_content(file_path, save_images=False, image_output_dir='images'):
    doc = Document(file_path)
    body = doc._element.body
    ordered_content = []
    image_count = 0

    # Prepare image directory
    if save_images:
        os.makedirs(image_output_dir, exist_ok=True)

    # Map XML <w:p> element to clean paragraph text
    para_lookup = {
        p._element: p.text.strip()
        for p in doc.paragraphs
        if p.text and p.text.strip()
    }

    for child in body.iterchildren():
        tag = child.tag

        # -------- Paragraph --------
        if tag == qn('w:p'):
            para_text = para_lookup.get(child, "")
            if para_text:
                ordered_content.append(('paragraph', para_text))

        # -------- Table --------
        elif tag == qn('w:tbl'):
            table_data = []
            rows = child.findall('.//w:tr', namespaces=NSMAP)
            for row in rows:
                cells = row.findall('.//w:tc', namespaces=NSMAP)
                row_data = []
                for cell in cells:
                    clean_text = get_cell_text(cell)
                    row_data.append(clean_text)
                table_data.append(row_data)
            ordered_content.append(('table', table_data))

    # -------- Images --------
    for rel in doc.part._rels.values():
        if "image" in rel.target_ref:
            image_count += 1
            image_label = f"Image_{image_count}"
            ordered_content.append(('image', image_label))

            if save_images:
                ext = rel.target_ref.split('.')[-1]
                image_path = os.path.join(image_output_dir, f"{image_label}.{ext}")
                with open(image_path, "wb") as f:
                    f.write(rel.target_part.blob)

    return ordered_content
